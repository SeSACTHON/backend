name: CI ApplicationSet Validation

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "clusters/**/apps/*-appset.yaml"
      - "platform/helm/**/app.yaml"
      - "scripts/ci/lint-appset-templates.sh"
      - ".github/workflows/ci-appset.yml"
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "clusters/**/apps/*-appset.yaml"
      - "platform/helm/**/app.yaml"
      - "scripts/ci/lint-appset-templates.sh"
      - ".github/workflows/ci-appset.yml"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-appset-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  commit-filter:
    name: üõÇ Commit Filter
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.detect.outputs.skip }}
      reason: ${{ steps.detect.outputs.reason }}
    steps:
      - name: Detect conventional commit type
        id: detect
        run: |
          set -euo pipefail
          EVENT_NAME="${{ github.event_name }}"
          if [ "$EVENT_NAME" = "pull_request" ]; then
            REF_TEXT="${{ github.event.pull_request.title }}"
          else
            REF_TEXT="${{ github.event.head_commit.message }}"
          fi
          REF_TEXT="${REF_TEXT:-none}"
          TYPE=$(echo "$REF_TEXT" | sed -n 's/^\([A-Za-z0-9_-]\+\):.*/\1/p' | tr '[:upper:]' '[:lower:]')
          if [[ "$TYPE" =~ ^(docs)$ ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=Commit type '$TYPE' is configured to bypass AppSet CI" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "reason=" >> "$GITHUB_OUTPUT"
          fi

  skip-notice:
    name: ‚è≠Ô∏è CI Skipped
    needs: commit-filter
    if: needs.commit-filter.outputs.skip == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Publish skip summary
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## ‚è≠Ô∏è AppSet CI Skipped
          - Reason: ${{ needs.commit-filter.outputs.reason }}
          EOF

  appset-lint:
    name: üßπ ApplicationSet Lint
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce template style
        run: scripts/ci/lint-appset-templates.sh


