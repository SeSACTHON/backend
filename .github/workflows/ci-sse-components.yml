name: CI SSE Components

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "domains/sse-gateway/**"
      - "domains/event-router/**"
      - "domains/_shared/events/**"
      - "workloads/domains/sse-gateway/**"
      - "workloads/domains/event-router/**"
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "domains/sse-gateway/**"
      - "domains/event-router/**"
      - "domains/_shared/events/**"
      - "workloads/domains/sse-gateway/**"
      - "workloads/domains/event-router/**"
  workflow_dispatch:
    inputs:
      force_all:
        description: "Î™®Îì† SSE Ïª¥Ìè¨ÎÑåÌä∏Î•º Í∞ïÏ†úÎ°ú ÎπåÎìú/Ìë∏Ïãú"
        type: boolean
        default: false
      target_components:
        description: "ÏΩ§ÎßàÎ°ú Íµ¨Î∂ÑÎêú Ïª¥Ìè¨ÎÑåÌä∏ Ïù¥Î¶Ñ Î™©Î°ù (Ïòà: sse-gateway,event-router)"
        required: false

permissions:
  contents: write
  packages: write

concurrency:
  group: ci-sse-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  commit-filter:
    name: üõÇ Commit Filter
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.detect.outputs.skip }}
      reason: ${{ steps.detect.outputs.reason }}
      commit_type: ${{ steps.detect.outputs.commit_type }}
    steps:
      - name: Detect conventional commit type
        id: detect
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          set -euo pipefail
          if [ "${GITHUB_ACTOR}" = "github-actions[bot]" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=Triggered by github-actions bot (manifest bump)" >> "$GITHUB_OUTPUT"
            echo "commit_type=bot" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "$EVENT_NAME" = "pull_request" ]; then
            REF_TEXT="$PR_TITLE"
          else
            REF_TEXT="${COMMIT_MSG%%$'\n'*}"
          fi
          REF_TEXT="${REF_TEXT:-none}"
          TYPE=$(printf '%s\n' "$REF_TEXT" | sed -n 's/^\([A-Za-z0-9_-]\+\):.*/\1/p' | tr '[:upper:]' '[:lower:]')
          if [[ "$TYPE" =~ ^(docs)$ ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=Commit type '$TYPE' is configured to bypass SSE CI" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "reason=" >> "$GITHUB_OUTPUT"
          fi
          if [ -z "$TYPE" ]; then
            TYPE="unknown"
          fi
          echo "commit_type=$TYPE" >> "$GITHUB_OUTPUT"

  skip-notice:
    name: ‚è≠Ô∏è CI Skipped
    needs: commit-filter
    if: needs.commit-filter.outputs.skip == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Publish skip summary
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## ‚è≠Ô∏è SSE Components CI Skipped
          - Reason: ${{ needs.commit-filter.outputs.reason }}
          - Commit type: `${{ needs.commit-filter.outputs.commit_type }}`
          EOF

  detect-changes:
    name: üîç Detect SSE Component Changes
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    outputs:
      has_changes: ${{ steps.prepare.outputs.has_changes }}
      components: ${{ steps.prepare.outputs.components }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Changed files
        id: changes
        uses: tj-actions/changed-files@v45
        with:
          files: |
            domains/sse-gateway/**
            domains/event-router/**
            domains/_shared/events/**
            workloads/domains/sse-gateway/**
            workloads/domains/event-router/**

      - name: Prepare component matrix
        id: prepare
        run: |
          python3 <<'PYEOF'
          import json
          import os
          import sys
          from collections import OrderedDict

          files = os.environ.get("CHANGED_FILES", "").split()
          any_changed = os.environ.get("ANY_CHANGED", "false").lower() == "true"
          event_name = os.environ.get("EVENT_NAME", "")
          force_all = os.environ.get("FORCE_ALL", "false").lower() == "true"

          # SSE Ïª¥Ìè¨ÎÑåÌä∏ Î™©Î°ù (API suffix ÏóÜÏù¥ ÎπåÎìúÎêòÎäî ÏÑúÎπÑÏä§Îì§)
          SSE_COMPONENTS = [
              "sse-gateway",
              "event-router",
          ]

          # Í≥µÏú† ÏΩîÎìúÍ∞Ä Î≥ÄÍ≤ΩÎêòÎ©¥ ÏòÅÌñ•Î∞õÎäî Ïª¥Ìè¨ÎÑåÌä∏
          shared_triggers = {
              "domains/_shared/events": ["sse-gateway", "event-router"],
          }

          raw_targets = [
              s.strip()
              for s in os.environ.get("TARGET_COMPONENTS", "").split(",")
              if s.strip()
          ]

          components = []
          all_components = sorted(SSE_COMPONENTS)

          if event_name == "workflow_dispatch":
              if force_all:
                  components = all_components
              elif raw_targets:
                  invalid = [c for c in raw_targets if c not in all_components]
                  if invalid:
                      sys.stderr.write(f"Unknown components: {', '.join(invalid)}\n")
                      sys.exit(1)
                  components = list(OrderedDict.fromkeys(raw_targets))

          if not components and any_changed:
              for path in files:
                  # shared Í≤ΩÎ°úÏóê ÎåÄÌïú Ìä∏Î¶¨Í±∞
                  for prefix, comp_list in shared_triggers.items():
                      if path.startswith(prefix):
                          for comp in comp_list:
                              if comp in all_components and comp not in components:
                                  components.append(comp)

                  parts = path.split("/")
                  # domains/<component>/ Í≤ΩÎ°ú Í∞êÏßÄ
                  if len(parts) >= 2 and parts[0] == "domains":
                      comp = parts[1]
                      if comp and comp in all_components and comp not in components:
                          components.append(comp)
                  # workloads/domains/<component>/ Í≤ΩÎ°ú Í∞êÏßÄ
                  elif len(parts) >= 3 and parts[0] == "workloads" and parts[1] == "domains":
                      comp = parts[2]
                      if comp and comp in all_components and comp not in components:
                          components.append(comp)

          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              if components:
                  out.write("has_changes=true\n")
                  out.write(f"components={json.dumps(components)}\n")
              else:
                  out.write("has_changes=false\n")
                  out.write("components=[]\n")
          PYEOF
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.all_changed_files }}
          ANY_CHANGED: ${{ steps.changes.outputs.any_changed }}
          EVENT_NAME: ${{ github.event_name }}
          FORCE_ALL: ${{ github.event.inputs.force_all || 'false' }}
          TARGET_COMPONENTS: ${{ github.event.inputs.target_components || '' }}

  quality:
    name: üß™ SSE Lint & Test
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-changes
    if: >
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-changes.outputs.has_changes == 'true'
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    strategy:
      fail-fast: false
      matrix:
        component: ${{ fromJson(needs.detect-changes.outputs.components) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install black==24.4.2 ruff==0.6.9 pytest==8.3.3 pytest-asyncio==0.24.0
          pip install -r domains/${{ matrix.component }}/requirements.txt

      - name: Black (format check)
        run: black --check domains/${{ matrix.component }}

      - name: Ruff lint
        run: ruff check domains/${{ matrix.component }}

      - name: Pytest
        working-directory: domains/${{ matrix.component }}
        env:
          PYTHONPATH: ${{ github.workspace }}/domains/${{ matrix.component }}
        run: pytest

  build-push:
    name: üì¶ Build & Push SSE Images
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-changes
      - quality
    if: >
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        component: ${{ fromJson(needs.detect-changes.outputs.components) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare image tags
        id: meta
        run: |
          set -euo pipefail
          SHORT_SHA=$(git rev-parse --short=6 HEAD)
          COMPONENT="${{ matrix.component }}"
          IMAGE_REPO="docker.io/mng990/eco2"
          
          # SSE Ïª¥Ìè¨ÎÑåÌä∏Îäî -api suffix ÏóÜÏù¥ ÎπåÎìú
          # sse-gateway ‚Üí sse-gateway
          # event-router ‚Üí event-router
          COMPONENT_SLUG="${COMPONENT}"
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            IS_PR=true
            BASE_REF="${{ github.event.pull_request.base.ref }}"
          else
            IS_PR=false
            BASE_REF="${GITHUB_REF##*/}"
          fi
          
          VERSION=$(cat VERSION)
          
          if [ "$BASE_REF" = "main" ] && [ "$IS_PR" = "false" ]; then
            UNIQUE_TAG="${COMPONENT_SLUG}-${VERSION}-${SHORT_SHA}"
            {
              echo "tags<<TAGS"
              echo "${IMAGE_REPO}:${UNIQUE_TAG}"
              echo "${IMAGE_REPO}:${COMPONENT_SLUG}-prod-latest"
              echo "${IMAGE_REPO}:${COMPONENT_SLUG}-latest"
              echo "TAGS"
            } >> "$GITHUB_OUTPUT"
            echo "tag_name=${UNIQUE_TAG}" >> "$GITHUB_OUTPUT"
            echo "manifest_tag=${UNIQUE_TAG}" >> "$GITHUB_OUTPUT"
          else
            DEV_TAG="${COMPONENT_SLUG}-dev-${SHORT_SHA}"
            DEV_LATEST_TAG="${COMPONENT_SLUG}-dev-latest"
            {
              echo "tags<<TAGS"
              echo "${IMAGE_REPO}:${DEV_TAG}"
              echo "${IMAGE_REPO}:${DEV_LATEST_TAG}"
              echo "TAGS"
            } >> "$GITHUB_OUTPUT"
            echo "tag_name=${DEV_TAG}" >> "$GITHUB_OUTPUT"
            echo "manifest_tag=${DEV_LATEST_TAG}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: domains/${{ matrix.component }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Sync manifest branch
        if: >
          (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          git fetch origin "${BRANCH_NAME}"
          git checkout -B "${BRANCH_NAME}"
          git pull --rebase origin "${BRANCH_NAME}"

      - name: Update dev manifest tag
        if: >
          github.ref == 'refs/heads/develop'
        id: update_dev
        env:
          KUSTOMIZE_FILE: workloads/domains/${{ matrix.component }}/dev/kustomization.yaml
          TAG_NAME: ${{ steps.meta.outputs.manifest_tag }}
        run: |
          python -m pip install --upgrade pip pyyaml
          python scripts/ci/update_kustomize_image.py \
            --file "$KUSTOMIZE_FILE" \
            --image docker.io/mng990/eco2 \
            --tag "$TAG_NAME"
          if git diff --quiet -- "$KUSTOMIZE_FILE"; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "file=$KUSTOMIZE_FILE" >> "$GITHUB_OUTPUT"
          fi

      - name: Update prod manifest tag
        if: >
          github.ref == 'refs/heads/main'
        id: update_prod
        env:
          KUSTOMIZE_FILE: workloads/domains/${{ matrix.component }}/prod/kustomization.yaml
          TAG_NAME: ${{ steps.meta.outputs.tag_name }}
        run: |
          python -m pip install --upgrade pip pyyaml
          python scripts/ci/update_kustomize_image.py \
            --file "$KUSTOMIZE_FILE" \
            --image docker.io/mng990/eco2 \
            --tag "$TAG_NAME"
          if git diff --quiet -- "$KUSTOMIZE_FILE"; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "file=$KUSTOMIZE_FILE" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit manifest updates
        if: >
          (steps.update_dev.outputs.changed == 'true') ||
          (steps.update_prod.outputs.changed == 'true')
        env:
          DEV_FILE: ${{ steps.update_dev.outputs.file }}
          PROD_FILE: ${{ steps.update_prod.outputs.file }}
          TAG_NAME: ${{ steps.meta.outputs.manifest_tag }}
          COMPONENT: ${{ matrix.component }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "${DEV_FILE}" ]; then git add "${DEV_FILE}"; fi
          if [ -n "${PROD_FILE}" ]; then git add "${PROD_FILE}"; fi
          git commit -m "chore(${COMPONENT}): bump image tag to ${TAG_NAME} [skip ci]"
          git push origin HEAD:${GITHUB_REF_NAME}

