---
# KEDA ScaledObject for scan-worker
# RabbitMQ 큐 길이 기반 오토스케일링
# 트리거: scan.* 큐에 메시지가 쌓이면 worker pod 증가
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: scan-worker-scaledobject
  namespace: scan
  labels:
    app: scan-worker
spec:
  scaleTargetRef:
    name: scan-worker
    kind: Deployment
  # 스케일링 범위
  minReplicaCount: 1
  maxReplicaCount: 10
  # 쿨다운 기간 (스케일업 후 최소 대기 시간)
  cooldownPeriod: 120  # 30s → 120s (스케일링 진동 방지)
  # 폴링 간격
  pollingInterval: 15
  # 고급 설정
  advanced:
    restoreToOriginalReplicaCount: false
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 300  # 120s → 300s (5분 안정화)
          policies:
          - type: Percent
            value: 50
            periodSeconds: 60
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
          - type: Pods
            value: 2
            periodSeconds: 30
  triggers:
  # RabbitMQ 큐 길이 트리거 (scan.vision)
  - type: rabbitmq
    metadata:
      protocol: amqp
      queueName: scan.vision
      mode: QueueLength
      value: '10'  # 큐에 10개 이상 메시지 → 스케일 업
    authenticationRef:
      name: rabbitmq-trigger-auth
  # RabbitMQ 큐 길이 트리거 (scan.answer)
  - type: rabbitmq
    metadata:
      protocol: amqp
      queueName: scan.answer
      mode: QueueLength
      value: '10'
    authenticationRef:
      name: rabbitmq-trigger-auth
  # RabbitMQ 큐 길이 트리거 (scan.rule)
  - type: rabbitmq
    metadata:
      protocol: amqp
      queueName: scan.rule
      mode: QueueLength
      value: '20'  # rule은 빠르므로 임계값 높게
    authenticationRef:
      name: rabbitmq-trigger-auth
---
# KEDA TriggerAuthentication for RabbitMQ
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: rabbitmq-trigger-auth
  namespace: scan
spec:
  secretTargetRef:
  - parameter: host
    name: scan-secret
    key: CELERY_BROKER_URL
