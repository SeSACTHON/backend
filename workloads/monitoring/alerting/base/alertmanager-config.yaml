# AlertmanagerConfig CR for Slack integration
# Note: Slack webhook URL is provided via ExternalSecret (alertmanager-slack-webhook)
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: slack-alerts
  namespace: prometheus
  labels:
    alertmanagerConfig: slack
spec:
  route:
    groupBy:
    - alertname
    - namespace
    - severity
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 4h
    receiver: slack-warning
    routes:
    # Critical alerts - 拾괣긮 詢껆붶
    - receiver: slack-critical
      matchers:
      - name: severity
        value: critical
        matchType: =
      continue: false
    # Warning alerts
    - receiver: slack-warning
      matchers:
      - name: severity
        value: warning
        matchType: =
      continue: false
    # Watchdog 細얿긮 (null receiver)
    - receiver: 'null'
      matchers:
      - name: alertname
        value: Watchdog
        matchType: =
      continue: false

  receivers:
  - name: 'null'
  - name: slack-critical
    slackConfigs:
    - apiURL:
        name: alertmanager-slack-webhook
        key: webhook-url
      channel: '#alerts'
      sendResolved: true
      title: '{{ if eq .Status "resolved" }}游릭 [RESOLVED]{{ else }}游댮 [CRITICAL]{{ end }} {{ .GroupLabels.alertname }}'
      text: |
        *Cluster:* eco2-dev
        *Namespace:* {{ .GroupLabels.namespace }}
        *Severity:* {{ .GroupLabels.severity }}

        {{ range .Alerts }}
        *Alert:* {{ .Labels.alertname }}
        *Description:* {{ .Annotations.description }}
        {{ if eq $.Status "resolved" }}*Resolved:* {{ .EndsAt.Format "2006-01-02 15:04:05" }}{{ else }}*Started:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}{{ end }}
        {{ end }}
      color: '{{ if eq .Status "resolved" }}#36a64f{{ else }}#ff0000{{ end }}'

  - name: slack-warning
    slackConfigs:
    - apiURL:
        name: alertmanager-slack-webhook
        key: webhook-url
      channel: '#alerts'
      sendResolved: true
      title: '{{ if eq .Status "resolved" }}游릭 [RESOLVED]{{ else }}游 [WARNING]{{ end }} {{ .GroupLabels.alertname }}'
      text: |
        *Cluster:* eco2-dev
        *Namespace:* {{ .GroupLabels.namespace }}
        *Severity:* {{ .GroupLabels.severity }}

        {{ range .Alerts }}
        *Alert:* {{ .Labels.alertname }}
        *Description:* {{ .Annotations.description }}
        {{ if eq $.Status "resolved" }}*Resolved:* {{ .EndsAt.Format "2006-01-02 15:04:05" }}{{ end }}
        {{ end }}
      color: '{{ if eq .Status "resolved" }}#36a64f{{ else }}#ffa500{{ end }}'

  - name: slack-info
    slackConfigs:
    - apiURL:
        name: alertmanager-slack-webhook
        key: webhook-url
      channel: '#alerts'
      sendResolved: true
      title: '{{ if eq .Status "resolved" }}游릭 [RESOLVED]{{ else }}游리 [INFO]{{ end }} {{ .GroupLabels.alertname }}'
      text: |
        *Cluster:* eco2-dev
        *Namespace:* {{ .GroupLabels.namespace }}

        {{ range .Alerts }}
        *Alert:* {{ .Labels.alertname }}
        *Description:* {{ .Annotations.description }}
        {{ end }}
      color: '{{ if eq .Status "resolved" }}#36a64f{{ else }}#ffff00{{ end }}'
