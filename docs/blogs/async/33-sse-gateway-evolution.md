# SSE Gateway ì•„í‚¤í…ì²˜ ì§„í™”: ë‹¨ì¼ Consumerì—ì„œ ë¶„ì‚° Fan-outê¹Œì§€

> **ì‘ì„±ì¼**: 2024-12-27  
> **í™˜ê²½**: dev (ap-northeast-2)  
> **ëª©ì **: SSE Gateway ì•„í‚¤í…ì²˜ì˜ ì§„í™” ê³¼ì •ê³¼ ë°œê²¬ëœ í•œê³„ì  ë¬¸ì„œí™”

---

## 1. ê°œìš”

### 1.1. ë°°ê²½

50+ VU(Virtual Users) ë¶€í•˜ í…ŒìŠ¤íŠ¸ì—ì„œ ë°œìƒí•œ SSE ì—°ê²° ë³‘ëª©ì„ í•´ê²°í•˜ê¸° ìœ„í•´ ì•„í‚¤í…ì²˜ë¥¼ ë‹¨ê³„ë³„ë¡œ ì§„í™”ì‹œì¼°ìŠµë‹ˆë‹¤.

**ì§„í™” ê³¼ì •:**
1. **ì—°ê²°ë‹¹ XREAD** â†’ 50 VUì—ì„œ CPU 85% ë³‘ëª©
2. **ë‹¨ì¼ SSE-Gateway** â†’ ê¹”ë”í•œ ì´ë²¤íŠ¸ ìˆ˜ì‹ , ìˆ˜í‰í™•ì¥ ë¶ˆê°€
3. **StatefulSet + Consistent Hash** â†’ í•´ì‹± ì •í•©ì„± ë¶ˆì¼ì¹˜
4. **Fan-out ê³„ì¸µ í•„ìš”ì„±** â† í˜„ì¬ ë‹¨ê³„

### 1.2. ê´€ë ¨ ë¬¸ì„œ

- [31-sse-fanout-optimization.md](./31-sse-fanout-optimization.md) - Fan-out íŒ¨í„´ ì„¤ê³„
- [32-sse-sharding-troubleshooting.md](./32-sse-sharding-troubleshooting.md) - ìƒ¤ë”© êµ¬í˜„ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

---

## 2. Phase 1: ë‹¨ì¼ SSE-Gatewayë¡œ ì „í™˜

### 2.1. ì´ì „ ì•„í‚¤í…ì²˜ ë¬¸ì œì 

**ì—°ê²°ë‹¹ XREAD ëª¨ë¸ (N:N):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ì—°ê²°ë‹¹ XREAD (AS-IS)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Client 1 â”€â”€â†’ [while True: XREAD] â”€â”€â†’ scan:events:job-1    â”‚
â”‚  Client 2 â”€â”€â†’ [while True: XREAD] â”€â”€â†’ scan:events:job-2    â”‚
â”‚  Client 3 â”€â”€â†’ [while True: XREAD] â”€â”€â†’ scan:events:job-3    â”‚
â”‚      ...                                    ...             â”‚
â”‚  Client N â”€â”€â†’ [while True: XREAD] â”€â”€â†’ scan:events:job-N    â”‚
â”‚                                                             â”‚
â”‚  â†’ Nê°œì˜ SSE ì—°ê²° = Nê°œì˜ asyncio ì½”ë£¨í‹´ = Nê°œì˜ XREAD ë£¨í”„  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**50 VU í…ŒìŠ¤íŠ¸ ê²°ê³¼:**

```
$ k6 run --vus 50 --duration 2m k6-sse-test.js

     âœ— SSE stream completed
      â†³  62% â€” âœ“ 31 / âœ— 19

     http_req_duration.........: avg=8.2s    p(95)=15.3s
     http_req_failed............: 38.00%
```

**ê´€ì¸¡ëœ ì¦ìƒ:**
| ì§€í‘œ | ê°’ | ë¬¸ì œ |
|------|-----|------|
| Pod CPU | 85% | asyncio ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ê³¼ë‹¤ |
| XREAD/ì´ˆ | 10íšŒ | 50 VU Ã— 5ì´ˆ timeout |
| ì™„ë£Œìœ¨ | 62% | Connection closed by server |
| keepalive | 10íšŒ/ì´ˆ | ë¶ˆí•„ìš”í•œ ì˜¤ë²„í—¤ë“œ |

### 2.2. ë‹¨ì¼ Consumer ëª¨ë¸ë¡œ ì „í™˜

**ìƒˆë¡œìš´ ì•„í‚¤í…ì²˜ (1:N Fan-out):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ë‹¨ì¼ Consumer + Fan-out (TO-BE)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 SSE-Gateway (ë‹¨ì¼)                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚         SSEBroadcastManager (Singleton)         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Background Task: XREAD (1ê°œë§Œ ì‹¤í–‰)       â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚     while True:                           â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚       events = redis.xread(...)           â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚       for event in events:                â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚         broadcast_to_subscribers(event)   â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚                      â”‚                          â”‚ â”‚   â”‚
â”‚  â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚     â–¼                â–¼                â–¼         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  [Queue 1]       [Queue 2]       [Queue N]      â”‚ â”‚   â”‚
â”‚  â”‚  â”‚     â”‚                â”‚                â”‚         â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚        â–¼                â–¼                â–¼           â”‚   â”‚
â”‚  â”‚   Client 1         Client 2         Client N        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  âœ… XREAD 1ê°œ â†’ Nê°œ í´ë¼ì´ì–¸íŠ¸ì— Memory Fan-out              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3. í•µì‹¬ êµ¬í˜„

**SSEBroadcastManager (Singleton):**

```python
# domains/sse-gateway/core/broadcast_manager.py

class SSEBroadcastManager:
    """ë‹¨ì¼ Redis Consumer + Memory Fan-out."""
    
    _instance: ClassVar[SSEBroadcastManager | None] = None
    
    def __init__(self):
        self._subscribers: dict[str, set[SubscriberQueue]] = defaultdict(set)
        self._background_task: asyncio.Task | None = None
        
    async def _consumer_loop(self):
        """ë‹¨ì¼ Background Task: Redis XREAD."""
        while not self._shutdown:
            # ë‹¨ 1ê°œì˜ XREAD í˜¸ì¶œ
            events = await self._streams_client.xread(
                {self._stream_key: self._last_id},
                block=5000,
                count=100,
            )
            
            for stream_name, messages in events:
                for msg_id, data in messages:
                    job_id = data.get("job_id")
                    # Memory Fan-out: í•´ë‹¹ job êµ¬ë…ìë“¤ì—ê²Œ ì „ë‹¬
                    for subscriber in self._subscribers.get(job_id, []):
                        await subscriber.put_event(data)
                    self._last_id = msg_id
```

### 2.4. ì „í™˜ ê²°ê³¼

**í…ŒìŠ¤íŠ¸ ê²°ê³¼ (ë™ì¼ 50 VU):**

```bash
$ /tmp/sse-realtime-test.sh

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
       SSE ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìˆ˜ì‹  í…ŒìŠ¤íŠ¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[1/2] POST /api/v1/scan - ì‘ì—… ì œì¶œ...
âœ… job_id: fc052f15-449f-4ce4-aa96-99d400ed7865
   â†’ ì˜ˆìƒ shard: 0 (sse-gateway-0ê°€ ì²˜ë¦¬)

[2/2] GET /api/v1/stream - SSE ì—°ê²° (60ì´ˆ íƒ€ì„ì•„ì›ƒ)...

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                 ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìˆ˜ì‹  ì¤‘...
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[14:10:14] ğŸ“¨ Event: queued
            â””â”€ stage=queued, status=started, progress=0%, seq=0
[14:10:14] ğŸ“¨ Event: vision
            â””â”€ stage=vision, status=started, progress=0%, seq=10
[14:10:18] ğŸ“¨ Event: vision
            â””â”€ stage=vision, status=completed, progress=25%, seq=11
[14:10:18] ğŸ“¨ Event: rule
            â””â”€ stage=rule, status=started, progress=25%, seq=20
[14:10:18] ğŸ“¨ Event: rule
            â””â”€ stage=rule, status=completed, progress=50%, seq=21
[14:10:18] ğŸ“¨ Event: answer
            â””â”€ stage=answer, status=started, progress=50%, seq=30
[14:10:21] ğŸ“¨ Event: answer
            â””â”€ stage=answer, status=completed, progress=75%, seq=31
[14:10:21] ğŸ“¨ Event: reward
            â””â”€ stage=reward, status=started, progress=75%, seq=40
[14:10:22] ğŸ“¨ Event: reward
            â””â”€ stage=reward, status=completed, progress=100%, seq=41
[14:10:22] ğŸ“¨ Event: done
            â””â”€ stage=done, status=completed, progress=%, seq=51

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                   âœ… ì‘ì—… ì™„ë£Œ!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**ì„±ëŠ¥ ê°œì„ :**

| ì§€í‘œ | Before | After | ê°œì„  |
|------|--------|-------|------|
| Pod CPU | 85% | 15% | **-70%** |
| XREAD/ì´ˆ | 10íšŒ | 1íšŒ | **-90%** |
| ì™„ë£Œìœ¨ | 62% | 100% | **+38%** |
| asyncio ì½”ë£¨í‹´ | 50ê°œ | 1ê°œ | **-98%** |

---

## 3. Phase 2: ìˆ˜í‰í™•ì¥ ì œì•½ ë°œê²¬

### 3.1. ë‹¨ì¼ Pod í•œê³„

**ë¬¸ì œ ìƒí™©:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ë‹¨ì¼ SSE-Gatewayì˜ í•œê³„                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              SSE-Gateway (replicas=1)                â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚     âŒ ë‹¨ì¼ ì¥ì• ì  (SPOF)                             â”‚   â”‚
â”‚  â”‚     âŒ ìˆ˜í‰í™•ì¥ ë¶ˆê°€ (HPA ë¬´ì˜ë¯¸)                      â”‚   â”‚
â”‚  â”‚     âŒ ë…¸ë“œ ì¥ì•  ì‹œ ì „ì²´ SSE ì—°ê²° ëŠê¹€                 â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Client 1 â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  Client 2 â”€â”€â”€â”€â”€â”¼â”€â”€â”€â†’ ???                                   â”‚
â”‚  Client N â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                                                             â”‚
â”‚  ğŸš¨ ì–´ë–¤ Podë¡œ ì—°ê²°í•´ì•¼ ì´ë²¤íŠ¸ë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ”ê°€?             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2. ìˆ˜í‰í™•ì¥ ì‹œë„ì˜ ì–´ë ¤ì›€

**ë‹¨ìˆœ replicas ì¦ê°€ ì‹œ ë¬¸ì œ:**

```yaml
# ì´ë ‡ê²Œ í•˜ë©´ ì•ˆë¨!
spec:
  replicas: 4  # 4ê°œë¡œ ëŠ˜ë¦¼
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ìˆ˜í‰í™•ì¥ ì‹œ ë¬¸ì œì                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Worker: job_id=xxx â†’ Redis Streamì— publish                â”‚
â”‚                                                             â”‚
â”‚  Client: GET /api/v1/stream?job_id=xxx                      â”‚
â”‚          â†“ Round Robin                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚     â”‚  Pod 0 (XREAD)  â† âŒ ë‹¤ë¥¸ Podì— ì—°ê²°ë¨     â”‚          â”‚
â”‚     â”‚  Pod 1 (XREAD)  â† âœ… ì´ë²¤íŠ¸ ìˆ˜ì‹  ê°€ëŠ¥      â”‚          â”‚
â”‚     â”‚  Pod 2 (XREAD)  â† âŒ ë‹¤ë¥¸ Podì— ì—°ê²°ë¨     â”‚          â”‚
â”‚     â”‚  Pod 3 (XREAD)  â† âŒ ë‹¤ë¥¸ Podì— ì—°ê²°ë¨     â”‚          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                             â”‚
â”‚  ğŸš¨ í´ë¼ì´ì–¸íŠ¸ê°€ ì´ë²¤íŠ¸ë¥¼ ê°€ì§„ Podì— ì—°ê²°ë˜ì–´ì•¼ í•¨!          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Phase 3: Istio Consistent Hash + ìƒ¤ë”© ë„ì…

### 4.1. ì„¤ê³„ ëª©í‘œ

**ìš”êµ¬ì‚¬í•­:**
1. ë™ì¼ job_idëŠ” í•­ìƒ ê°™ì€ Podë¡œ ë¼ìš°íŒ…
2. Pod ìˆ˜ ì¦ê°€í•´ë„ ê¸°ì¡´ ì—°ê²° ìœ ì§€
3. ìë™ ì¬ë¶„ë°° (Pod ì¶”ê°€/ì œê±° ì‹œ)

### 4.2. êµ¬í˜„ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Istio Consistent Hash + ìƒ¤ë”© (Bì•ˆ)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Istio Ingress Gateway                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ EnvoyFilter      â”‚    â”‚ DestinationRule                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ query â†’ header   â”‚â”€â”€â”€â–ºâ”‚ Consistent Hash (X-Job-Id)       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ job_id â†’ X-Job-Idâ”‚    â”‚ Ring Hash â†’ Pod ì„ íƒ             â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                  â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                   â”‚                  â”‚                  â”‚              â”‚
â”‚                   â–¼                  â–¼                  â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              SSE Gateway StatefulSet (replicas=4)                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚sse-gateway â”‚ â”‚sse-gateway â”‚ â”‚sse-gateway â”‚ â”‚sse-gateway â”‚    â”‚   â”‚
â”‚  â”‚  â”‚    -0      â”‚ â”‚    -1      â”‚ â”‚    -2      â”‚ â”‚    -3      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ shard: 0   â”‚ â”‚ shard: 1   â”‚ â”‚ shard: 2   â”‚ â”‚ shard: 3   â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚              â”‚              â”‚              â”‚               â”‚
â”‚           â–¼              â–¼              â–¼              â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Redis Streams (Sharded)                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚scan:events â”‚ â”‚scan:events â”‚ â”‚scan:events â”‚ â”‚scan:events â”‚    â”‚   â”‚
â”‚  â”‚  â”‚    :0      â”‚ â”‚    :1      â”‚ â”‚    :2      â”‚ â”‚    :3      â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â–²                                  â”‚
â”‚                                      â”‚ publish_stage_event              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      scan-worker (Celery)                        â”‚   â”‚
â”‚  â”‚         MD5(job_id) % 4 â†’ scan:events:Nì— publish                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3. í•µì‹¬ êµ¬í˜„

**EnvoyFilter (Query â†’ Header):**

```lua
-- workloads/routing/gateway/base/envoy-filter.yaml
function envoy_on_request(request_handle)
  -- /api/v1/stream?job_id=xxx â†’ X-Job-Id: xxx
  local path = request_handle:headers():get(":path")
  if path and string.find(path, "/api/v1/stream") then
    local job_id = string.match(path, "job_id=([^&]+)")
    if job_id then
      request_handle:headers():replace("X-Job-Id", job_id)
    end
  end
end
```

**DestinationRule (Consistent Hash):**

```yaml
# workloads/domains/sse-gateway/base/destinationrule.yaml
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: sse-gateway
spec:
  host: sse-gateway.sse-consumer.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpHeaderName: X-Job-Id  # ì´ í—¤ë”ë¡œ Pod ì„ íƒ
```

**Worker ìƒ¤ë”© (MD5 Hash):**

```python
# domains/_shared/events/redis_streams.py
def get_shard_for_job(job_id: str, shard_count: int = 4) -> int:
    """MD5 ê¸°ë°˜ ì¼ê´€ëœ shard ê³„ì‚°."""
    import hashlib
    hash_bytes = hashlib.md5(job_id.encode()).digest()[:8]
    hash_int = int.from_bytes(hash_bytes, byteorder="big")
    return hash_int % shard_count
```

### 4.4. í•´ì‹± ì •í•©ì„± ë¶ˆì¼ì¹˜ ë¬¸ì œ ë°œê²¬

**í…ŒìŠ¤íŠ¸ ê²°ê³¼:**

```bash
$ /tmp/sse-realtime-test.sh

[1/2] POST /api/v1/scan - ì‘ì—… ì œì¶œ...
âœ… job_id: 904fb02f-3e06-482c-b271-e641d3275d6b
   â†’ ì˜ˆìƒ shard: 1 (sse-gateway-1ê°€ ì²˜ë¦¬)

[2/2] GET /api/v1/stream - SSE ì—°ê²° (60ì´ˆ íƒ€ì„ì•„ì›ƒ)...

[14:52:28] ğŸ“¨ Event: queued
            â””â”€ stage=queued, status=started, progress=0%, seq=0
[14:52:43] ğŸ“¨ Event: keepalive
[14:52:58] ğŸ“¨ Event: keepalive
[14:53:13] ğŸ“¨ Event: keepalive

âŒ ì´ë²¤íŠ¸ ìˆ˜ì‹  ì•ˆë¨!
```

**ë¡œê·¸ ë¶„ì„:**

```bash
# SSE ìš”ì²­ì´ sse-gateway-3ìœ¼ë¡œ ë¼ìš°íŒ…ë¨
$ kubectl logs -n sse-consumer sse-gateway-3 -c sse-gateway --tail=10
INFO: 127.0.0.6:37031 - "GET /api/v1/stream?job_id=904fb02f... HTTP/1.1" 200 OK

# í•˜ì§€ë§Œ ì´ë²¤íŠ¸ëŠ” shard 1ì— ì €ì¥ë¨
$ kubectl exec -n redis rfr-streams-redis-0 -- redis-cli XRANGE scan:events:1 - + COUNT 3
1766814748351-0
job_id
904fb02f-3e06-482c-b271-e641d3275d6b
stage
queued
```

### 4.5. ì›ì¸ ë¶„ì„

| ì»´í¬ë„ŒíŠ¸ | í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ | Pod ì„ íƒ ë°©ì‹ |
|----------|---------------|---------------|
| **Worker (Python)** | MD5 â†’ `hash % 4` | ì§ì ‘ ê³„ì‚° |
| **Envoy (Istio)** | Ketama Ring Hash (xxhash) | Ring ê¸°ë°˜ ì„ íƒ |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   í•´ì‹± ì •í•©ì„± ë¶ˆì¼ì¹˜                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Worker (Python MD5):                                       â”‚
â”‚    job_id â†’ MD5 â†’ int % 4 â†’ shard 1                        â”‚
â”‚                                                             â”‚
â”‚  Envoy (Ketama Ring Hash):                                  â”‚
â”‚    Ring: [Pod0...Pod0...Pod1...Pod1...Pod2...Pod3...]      â”‚
â”‚                    ^                                        â”‚
â”‚           xxhash(job_id) â†’ Pod3 ì„ íƒ                        â”‚
â”‚                                                             â”‚
â”‚  ğŸš¨ WorkerëŠ” shard 1ì— ì €ì¥, í´ë¼ì´ì–¸íŠ¸ëŠ” Pod3ì— ì—°ê²°       â”‚
â”‚  ğŸš¨ Pod3ì€ shard 3ë§Œ XREAD â†’ ì´ë²¤íŠ¸ ëª» ë°›ìŒ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Phase 4: Fan-out ê³„ì¸µ í•„ìš”ì„± ëŒ€ë‘

### 5.1. í˜„ì¬ ìƒíƒœ

**ë¬¸ì œ ìš”ì•½:**
- Workerì˜ MD5 í•´ì‹œì™€ Envoyì˜ Ring Hashê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ
- í´ë¼ì´ì–¸íŠ¸ê°€ ì—°ê²°ëœ Podì™€ ì´ë²¤íŠ¸ê°€ ì €ì¥ëœ shardê°€ ë‹¤ë¦„
- ê²°ê³¼: ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹¤íŒ¨

### 5.2. í•´ê²° ë°©ì•ˆ ë¹„êµ

| ë°©ì•ˆ | ì„¤ëª… | ë³µì¡ë„ | íš¨ìœ¨ì„± |
|------|------|--------|--------|
| A. Workerê°€ Envoy Ring Hash ì¬í˜„ | Pythonì—ì„œ Ketama êµ¬í˜„ | ğŸ”´ ë§¤ìš° ë†’ìŒ | â­â­â­ |
| B-1. ëª¨ë“  Podê°€ ëª¨ë“  shard êµ¬ë… | ê¸°ì¡´ SSE-Gatewayì—ì„œ ëª¨ë“  shard XREAD | ğŸŸ¢ ë‚®ìŒ | â­â­ |
| B-2. Event Bus ê³„ì¸µ ë¶„ë¦¬ | Fan-out ì „ë‹´ ì»´í¬ë„ŒíŠ¸ ì¶”ê°€ | ğŸŸ¡ ì¤‘ê°„ | â­â­â­ |
| C. Headless Service + Pod DNS | ì§ì ‘ Pod ë¼ìš°íŒ… | ğŸŸ¡ ì¤‘ê°„ | â­â­â­ |

### 5.3. ë°©ì•ˆ B-1: ëª¨ë“  shard êµ¬ë… (ë‹¨ìˆœ êµ¬í˜„)

**ê°œë…:** ê¸°ì¡´ SSE-Gateway Podê°€ ìê¸° shardë§Œ ì½ëŠ” ëŒ€ì‹  **ëª¨ë“  shardë¥¼ XREAD**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      B-1: ëª¨ë“  shard êµ¬ë… (ë‹¨ìˆœ)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              SSE Gateway StatefulSet (replicas=4)                â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚sse-gateway â”‚ â”‚sse-gateway â”‚ â”‚sse-gateway â”‚ â”‚sse-gateway â”‚    â”‚   â”‚
â”‚  â”‚  â”‚    -0      â”‚ â”‚    -1      â”‚ â”‚    -2      â”‚ â”‚    -3      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚            â”‚ â”‚            â”‚ â”‚            â”‚ â”‚            â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ XREAD:     â”‚ â”‚ XREAD:     â”‚ â”‚ XREAD:     â”‚ â”‚ XREAD:     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ shard 0,1, â”‚ â”‚ shard 0,1, â”‚ â”‚ shard 0,1, â”‚ â”‚ shard 0,1, â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ 2,3 ì „ë¶€   â”‚ â”‚ 2,3 ì „ë¶€   â”‚ â”‚ 2,3 ì „ë¶€   â”‚ â”‚ 2,3 ì „ë¶€   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚            â”‚ â”‚            â”‚ â”‚            â”‚ â”‚            â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ job_idë¡œ   â”‚ â”‚ job_idë¡œ   â”‚ â”‚ job_idë¡œ   â”‚ â”‚ job_idë¡œ   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ í•„í„°ë§     â”‚ â”‚ í•„í„°ë§     â”‚ â”‚ í•„í„°ë§     â”‚ â”‚ í•„í„°ë§     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  âš ï¸ ë¬¸ì œ: 4 Pod Ã— 4 shard = 16 XREAD (ì¤‘ë³µ ì½ê¸° ë°œìƒ)                   â”‚
â”‚  âœ… ì¥ì : êµ¬í˜„ ê°„ë‹¨, ì¦‰ì‹œ ì ìš© ê°€ëŠ¥                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**êµ¬í˜„:**

```python
# domains/sse-gateway/core/broadcast_manager.py
async def _consumer_loop(self):
    """ëª¨ë“  shard êµ¬ë…."""
    while not self._shutdown:
        # ëª¨ë“  shardì—ì„œ XREAD (ì¤‘ë³µ ë°œìƒ)
        streams = {
            f"{STREAM_PREFIX}:{i}": self._last_ids[i]
            for i in range(self._shard_count)
        }
        
        events = await self._streams_client.xread(
            streams,
            block=5000,
            count=100,
        )
        
        for stream_name, messages in events:
            shard_id = int(stream_name.split(":")[-1])
            for msg_id, data in messages:
                job_id = data.get("job_id")
                # ì´ Podì— ì—°ê²°ëœ í´ë¼ì´ì–¸íŠ¸ ì¤‘ í•´ë‹¹ job êµ¬ë…ìì—ê²Œë§Œ ì „ë‹¬
                for subscriber in self._subscribers.get(job_id, []):
                    await subscriber.put_event(data)
                self._last_ids[shard_id] = msg_id
```

---

### 5.4. ë°©ì•ˆ B-2: Event Bus ê³„ì¸µ ë¶„ë¦¬ (ê¶Œì¥)

**ê°œë…:** Redis Consumerë¥¼ **ë³„ë„ì˜ Event Bus ì»´í¬ë„ŒíŠ¸ë¡œ ë¶„ë¦¬**, SSE-GatewayëŠ” ìˆœìˆ˜ ì—°ê²° ê´€ë¦¬ë§Œ ë‹´ë‹¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    B-2: Event Bus ê³„ì¸µ ë¶„ë¦¬ (ê¶Œì¥)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Istio Ingress Gateway                        â”‚   â”‚
â”‚  â”‚              Consistent Hash (X-Job-Id) â†’ Pod ì„ íƒ               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                      â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚         â–¼                        â–¼                        â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              SSE Gateway StatefulSet (replicas=N)                â”‚   â”‚
â”‚  â”‚                   (ìˆœìˆ˜ ì—°ê²° ê´€ë¦¬ + ë©”ì‹œì§€ ì „ë‹¬)                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚sse-gateway â”‚ â”‚sse-gateway â”‚ â”‚sse-gateway â”‚ â”‚sse-gateway â”‚    â”‚   â”‚
â”‚  â”‚  â”‚    -0      â”‚ â”‚    -1      â”‚ â”‚    -2      â”‚ â”‚    -3      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚            â”‚ â”‚            â”‚ â”‚            â”‚ â”‚            â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  Redis     â”‚ â”‚  Redis     â”‚ â”‚  Redis     â”‚ â”‚  Redis     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  Pub/Sub   â”‚ â”‚  Pub/Sub   â”‚ â”‚  Pub/Sub   â”‚ â”‚  Pub/Sub   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  êµ¬ë…ë§Œ    â”‚ â”‚  êµ¬ë…ë§Œ    â”‚ â”‚  êµ¬ë…ë§Œ    â”‚ â”‚  êµ¬ë…ë§Œ    â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚              â”‚              â”‚              â”‚               â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                  â–²                                      â”‚
â”‚                                  â”‚ Redis Pub/Sub                        â”‚
â”‚                                  â”‚ (channel: sse:events:{pod_id})       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Event Bus (Singleton Pod)                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                 ë‹¨ì¼ XREAD (ëª¨ë“  shard)                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  streams = {scan:events:0, scan:events:1, ..., :3}        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                         â”‚                                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                         â–¼                                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Consistent Hash ê³„ì‚° (Workerì™€ ë™ì¼í•œ MD5 ì‚¬ìš©)      â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ target_pod = hash(job_id) % pod_count               â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                         â”‚                                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                         â–¼                                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Redis Pub/Sub PUBLISH â†’ sse:events:{target_pod}          â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â–²                                      â”‚
â”‚                                  â”‚ XREAD (1íšŒë§Œ)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Redis Streams (Sharded)                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚scan:events â”‚ â”‚scan:events â”‚ â”‚scan:events â”‚ â”‚scan:events â”‚    â”‚   â”‚
â”‚  â”‚  â”‚    :0      â”‚ â”‚    :1      â”‚ â”‚    :2      â”‚ â”‚    :3      â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â–²                                      â”‚
â”‚                                  â”‚ publish_stage_event                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      scan-worker (Celery)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Event Bus êµ¬í˜„:**

```python
# domains/event-bus/core/router.py
class EventRouter:
    """Redis Streams â†’ Pub/Sub ë¼ìš°í„°."""
    
    def __init__(self, pod_count: int = 4):
        self._pod_count = pod_count
        self._last_ids: dict[int, str] = {i: "$" for i in range(4)}
    
    def _get_target_pod(self, job_id: str) -> int:
        """Workerì™€ ë™ì¼í•œ MD5 í•´ì‹œ ì‚¬ìš©."""
        import hashlib
        hash_bytes = hashlib.md5(job_id.encode()).digest()[:8]
        hash_int = int.from_bytes(hash_bytes, byteorder="big")
        return hash_int % self._pod_count
    
    async def run(self):
        """ë‹¨ì¼ Consumer: ëª¨ë“  shard XREAD â†’ ì•Œë§ì€ Podë¡œ Pub/Sub."""
        while True:
            streams = {
                f"scan:events:{i}": self._last_ids[i]
                for i in range(4)
            }
            
            events = await self._redis.xread(streams, block=5000, count=100)
            
            for stream_name, messages in events:
                shard_id = int(stream_name.split(":")[-1])
                for msg_id, data in messages:
                    job_id = data[b"job_id"].decode()
                    target_pod = self._get_target_pod(job_id)
                    
                    # í•´ë‹¹ Pod ì „ìš© ì±„ë„ë¡œ Publish
                    channel = f"sse:events:{target_pod}"
                    await self._redis.publish(channel, json.dumps(data))
                    
                    self._last_ids[shard_id] = msg_id
```

**SSE-Gateway (ë‹¨ìˆœí™”):**

```python
# domains/sse-gateway/core/subscriber.py
class SSESubscriber:
    """Redis Pub/Sub êµ¬ë…ë§Œ ë‹´ë‹¹."""
    
    async def subscribe(self, pod_id: int):
        """ìê¸° Pod ì „ìš© ì±„ë„ë§Œ êµ¬ë…."""
        channel = f"sse:events:{pod_id}"
        pubsub = self._redis.pubsub()
        await pubsub.subscribe(channel)
        
        async for message in pubsub.listen():
            if message["type"] == "message":
                event = json.loads(message["data"])
                job_id = event.get("job_id")
                # ë¡œì»¬ êµ¬ë…ìì—ê²Œ ì „ë‹¬
                for sub in self._subscribers.get(job_id, []):
                    await sub.put_event(event)
```

---

### 5.5. ë°©ì•ˆ ë¹„êµ

| í•­ëª© | B-1 (ëª¨ë“  shard êµ¬ë…) | B-2 (Event Bus ë¶„ë¦¬) |
|------|----------------------|---------------------|
| **Redis XREAD** | 4 Pod Ã— 4 shard = 16íšŒ | 1 Event Bus Ã— 4 shard = 4íšŒ |
| **ì´ë²¤íŠ¸ í•„í„°ë§** | ê° Podì—ì„œ job_id í•„í„° | Event Busì—ì„œ ë¼ìš°íŒ… |
| **ì •í•©ì„±** | âœ… í•­ìƒ ì¼ì¹˜ | âœ… í•­ìƒ ì¼ì¹˜ |
| **êµ¬í˜„ ë³µì¡ë„** | ğŸŸ¢ ë‚®ìŒ | ğŸŸ¡ ì¤‘ê°„ |
| **í™•ì¥ì„±** | âš ï¸ Pod ì¦ê°€ ì‹œ ë¶€í•˜ ì¦ê°€ | âœ… Event Busë§Œ ìŠ¤ì¼€ì¼ |
| **ì¥ì•  ì˜í–¥** | Podë³„ ë…ë¦½ì  | Event Bus ì¥ì•  ì‹œ ì „ì²´ ì˜í–¥ |
| **HPA ì§€ì›** | âš ï¸ ì œí•œì  | âœ… Pod ìˆ˜ ë³€ê²½ ì‹œ ìë™ ì¬ë¶„ë°° |

**ê¶Œì¥ ì§„í–‰ ìˆœì„œ:**

1. **ë‹¨ê¸° (ì¦‰ì‹œ):** B-1 ì ìš©í•˜ì—¬ ì •í•©ì„± ë¬¸ì œ í•´ê²°
2. **ì¤‘ê¸° (ì•ˆì •í™” í›„):** B-2ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ì—¬ íš¨ìœ¨ì„± í™•ë³´

---

## 6. ì¶”ê°€ êµ¬í˜„: Prometheus ë©”íŠ¸ë¦­

### 6.1. SSE-Gateway ë©”íŠ¸ë¦­ ì„¤ê³„

```python
# domains/sse-gateway/metrics.py

# === CCU (ë™ì‹œ ì—°ê²°) ===
SSE_CONNECTIONS_ACTIVE = Gauge(
    "sse_gateway_connections_active",
    "Active SSE connections (CCU)",
)

# === Event Rate ===
SSE_EVENTS_RECEIVED = Counter(
    "sse_gateway_events_received_total",
    "Total events received from Redis Streams",
    labelnames=["shard", "stage"],
)

SSE_EVENTS_DISTRIBUTED = Counter(
    "sse_gateway_events_distributed_total",
    "Total events distributed to clients",
    labelnames=["stage", "status"],  # status: success, dropped
)

# === Connection Churn ===
SSE_CONNECTIONS_CLOSED = Counter(
    "sse_gateway_connections_closed_total",
    "Total connections closed",
    labelnames=["reason"],  # normal, timeout, error, client_disconnect
)

SSE_CONNECTION_DURATION = Histogram(
    "sse_gateway_connection_duration_seconds",
    "Duration of SSE connections",
    buckets=exponential_buckets_range(1.0, 300.0, 15),
)

# === Write Latency ===
SSE_WRITE_LATENCY = Histogram(
    "sse_gateway_write_latency_seconds",
    "Time to write event to client",
    buckets=exponential_buckets_range(0.001, 0.1, 12),
)

# === Queue Backlog ===
SSE_QUEUE_SIZE_TOTAL = Gauge(
    "sse_gateway_queue_size_total",
    "Total queued events across all connections",
)

# === Redis Consumer ===
SSE_REDIS_XREAD_LATENCY = Histogram(
    "sse_gateway_redis_xread_latency_seconds",
    "XREAD latency",
    labelnames=["shard"],
    buckets=exponential_buckets_range(0.001, 0.5, 12),
)
```

### 6.2. ë²„í‚· ì„¤ì • (Go prometheus ìŠ¤íƒ€ì¼)

```python
def exponential_buckets_range(min_val: float, max_val: float, count: int) -> tuple:
    """Go prometheus.ExponentialBucketsRange í˜¸í™˜ êµ¬í˜„.
    
    - ë‚®ì€ latency êµ¬ê°„ì— ë” ì´˜ì´˜í•œ ë²„í‚· (p50/p90/p95/p99 ì •ë°€ ì¸¡ì •)
    - ~2x factor between buckets (Netflix/Google SRE ê¶Œì¥)
    """
    log_min = math.log(min_val)
    log_max = math.log(max_val)
    factor = (log_max - log_min) / (count - 1)
    return tuple(round(math.exp(log_min + factor * i), 4) for i in range(count))
```

---

## 7. í•µì‹¬ êµí›ˆ

### 7.1. ì•„í‚¤í…ì²˜ ì§„í™”

| Phase | ëª¨ë¸ | ì¥ì  | í•œê³„ |
|-------|------|------|------|
| 1 | ì—°ê²°ë‹¹ XREAD | ë‹¨ìˆœ | 50 VUì—ì„œ ë³‘ëª© |
| 2 | ë‹¨ì¼ Consumer | íš¨ìœ¨ì  | ìˆ˜í‰í™•ì¥ ë¶ˆê°€ |
| 3 | StatefulSet + Consistent Hash | ìˆ˜í‰í™•ì¥ | í•´ì‹± ì •í•©ì„± ë¶ˆì¼ì¹˜ |
| 4 | Fan-out Layer (ì˜ˆì •) | ì•ˆì •ì  | Redis ë¶€í•˜ ì¦ê°€ |

### 7.2. ë¶„ì‚° ì‹œìŠ¤í…œ ì›ì¹™

1. **ì¼ê´€ëœ í•´ì‹±**: ë™ì¼ ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš© í•„ìˆ˜
2. **SPOF ì œê±°**: ë‹¨ì¼ Pod ì˜ì¡´ ì§€ì–‘
3. **Trade-off ì¸ì‹**: íš¨ìœ¨ì„± vs ì •í•©ì„±

### 7.3. ë‹¤ìŒ ë‹¨ê³„

1. Fan-out Layer êµ¬í˜„ (ëª¨ë“  shard êµ¬ë…)
2. k6 CCU 50 í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
3. ë©”íŠ¸ë¦­ ê¸°ë°˜ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
4. HPA ì •ì±… ìˆ˜ë¦½ (ì»¤ë„¥ì…˜ ìˆ˜ ê¸°ë°˜)

---

## 8. ê´€ë ¨ ë¬¸ì„œ

- [31-sse-fanout-optimization.md](./31-sse-fanout-optimization.md) - Fan-out íŒ¨í„´ ì„¤ê³„
- [32-sse-sharding-troubleshooting.md](./32-sse-sharding-troubleshooting.md) - ìƒ¤ë”© íŠ¸ëŸ¬ë¸”ìŠˆíŒ…
- [27-keda-event-driven-autoscaling.md](./27-keda-event-driven-autoscaling.md) - KEDA ì˜¤í† ìŠ¤ì¼€ì¼ë§

---

## 9. ì°¸ê³  ìë£Œ

- [Envoy Consistent Hash](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#ring-hash)
- [Twitter Fan-out Architecture](https://blog.twitter.com/engineering/en_us/topics/infrastructure/2013/new-tweets-per-second-record-and-how)
- [Redis Streams ê³µì‹ ë¬¸ì„œ](https://redis.io/docs/latest/develop/data-types/streams/)

