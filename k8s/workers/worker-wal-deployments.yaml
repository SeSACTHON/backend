---
# Storage Worker PVC (Local SQLite WAL)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: storage-worker-wal-pvc
  namespace: default
  labels:
    app: storage-worker
    component: wal
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: gp3
---
# AI Worker PVC (Local SQLite WAL)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ai-worker-wal-pvc
  namespace: default
  labels:
    app: ai-worker
    component: wal
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: gp3
---
# Storage Worker Deployment with WAL
apiVersion: apps/v1
kind: Deployment
metadata:
  name: storage-worker
  namespace: default
  labels:
    app: storage-worker
    component: worker
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: storage-worker
  template:
    metadata:
      labels:
        app.kubernetes.io/name: storage-worker
        app.kubernetes.io/component: worker
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
    spec:
      nodeSelector:
        node-role: worker
      containers:
        - name: storage-worker
          image: ghcr.io/yourorg/ecoeco-storage-worker:latest
          command: ["celery", "-A", "workers.storage_worker", "worker", "--loglevel=info"]
          env:
            - name: RABBITMQ_URL
              value: "amqp://guest:guest@rabbitmq:5672//"
            - name: REDIS_URL
              value: "redis://redis:6379/0"
            - name: WAL_DB_PATH
              value: "/var/lib/ecoeco/wal/storage_worker.db"
            - name: POSTGRES_HOST
              value: "postgresql"
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_DB
              value: "ecoeco_storage"
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgresql-secret
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-secret
                  key: password
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: access-key-id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: secret-access-key
            - name: AWS_REGION
              value: "ap-northeast-2"
            - name: S3_BUCKET
              value: "ecoeco-images"
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          volumeMounts:
            - name: wal-storage
              mountPath: /var/lib/ecoeco/wal
          livenessProbe:
            exec:
              command:
                - celery
                - -A
                - workers.storage_worker
                - inspect
                - ping
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            exec:
              command:
                - celery
                - -A
                - workers.storage_worker
                - inspect
                - active
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 10
      volumes:
        - name: wal-storage
          persistentVolumeClaim:
            claimName: storage-worker-wal-pvc
      terminationGracePeriodSeconds: 60  # Graceful shutdown
---
# AI Worker Deployment with WAL
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-worker
  namespace: default
  labels:
    app: ai-worker
    component: worker
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: ai-worker
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ai-worker
        app.kubernetes.io/component: worker
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
    spec:
      nodeSelector:
        node-role: worker
      containers:
        - name: ai-worker
          image: ghcr.io/yourorg/ecoeco-ai-worker:latest
          command: ["celery", "-A", "workers.ai_worker", "worker", "--loglevel=info"]
          env:
            - name: RABBITMQ_URL
              value: "amqp://guest:guest@rabbitmq:5672//"
            - name: REDIS_URL
              value: "redis://redis:6379/1"
            - name: WAL_DB_PATH
              value: "/var/lib/ecoeco/wal/ai_worker.db"
            - name: POSTGRES_HOST
              value: "postgresql"
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_DB
              value: "ecoeco_ai"
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgresql-secret
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-secret
                  key: password
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: openai-secret
                  key: api-key
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 2Gi
          volumeMounts:
            - name: wal-storage
              mountPath: /var/lib/ecoeco/wal
          livenessProbe:
            exec:
              command:
                - celery
                - -A
                - workers.ai_worker
                - inspect
                - ping
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            exec:
              command:
                - celery
                - -A
                - workers.ai_worker
                - inspect
                - active
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 10
      volumes:
        - name: wal-storage
          persistentVolumeClaim:
            claimName: ai-worker-wal-pvc
      terminationGracePeriodSeconds: 60
---
# Storage Worker Service (Metrics)
apiVersion: v1
kind: Service
metadata:
  name: storage-worker
  namespace: default
  labels:
    app: storage-worker
    component: worker
spec:
  type: ClusterIP
  clusterIP: None  # Headless service for metrics collection
  ports:
    - port: 9090
      targetPort: 9090
      protocol: TCP
      name: metrics
  selector:
    app.kubernetes.io/name: storage-worker
---
# AI Worker Service (Metrics)
apiVersion: v1
kind: Service
metadata:
  name: ai-worker
  namespace: default
  labels:
    app: ai-worker
    component: worker
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - port: 9090
      targetPort: 9090
      protocol: TCP
      name: metrics
  selector:
    app.kubernetes.io/name: ai-worker

