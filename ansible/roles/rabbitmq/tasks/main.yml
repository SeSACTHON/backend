# RabbitMQ ì„¤ì¹˜ (Cluster Operator - CRD + Helm ê´€ë¦¬)
---
- name: RabbitMQ namespace ìƒì„±
  shell: kubectl create namespace {{ rabbitmq_namespace }} --dry-run=client -o yaml | kubectl apply -f -

- name: Helm ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸
  command: which helm
  register: helm_check
  failed_when: false
  changed_when: false

- name: Helm ì„¤ì¹˜
  shell: |
    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  when: helm_check.rc != 0

- name: RabbitMQ Operator ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸
  shell: kubectl get crd rabbitmqclusters.rabbitmq.com 2>/dev/null || echo "not_found"
  register: rabbitmq_crd_check
  changed_when: false
  failed_when: false

- name: RabbitMQ Cluster Operator ì„¤ì¹˜ (CRD + Deployment)
  when: "'not_found' in rabbitmq_crd_check.stdout"
  block:
    - name: RabbitMQ Cluster Operator ì„¤ì¹˜ (kubectl apply - CRD í¬í•¨)
      shell: |
        echo "ğŸ“¥ RabbitMQ Cluster Operator ì„¤ì¹˜ ì¤‘ (CRD í¬í•¨)..."
        kubectl apply -f https://github.com/rabbitmq/cluster-operator/releases/latest/download/cluster-operator.yml
      register: operator_install
      changed_when: "'created' in operator_install.stdout or 'configured' in operator_install.stdout"
    
    - name: RabbitMQ Cluster Operator ë°°í¬ ëŒ€ê¸°
      shell: |
        echo "â³ RabbitMQ Cluster Operator ë°°í¬ ëŒ€ê¸°..."
        # CRD ìƒì„± ëŒ€ê¸°
        for i in {1..30}; do
          if kubectl get crd rabbitmqclusters.rabbitmq.com >/dev/null 2>&1; then
            echo "âœ… CRD ìƒì„±ë¨"
            break
          fi
          echo "CRD ëŒ€ê¸° ì¤‘... ($i/30)"
          sleep 2
        done
        
        # Operator Deployment ëŒ€ê¸°
        for i in {1..60}; do
          if kubectl get deployment rabbitmq-cluster-operator -n rabbitmq-system >/dev/null 2>&1; then
            if kubectl wait --for=condition=available deployment/rabbitmq-cluster-operator -n rabbitmq-system --timeout=300s 2>/dev/null; then
              echo "âœ… RabbitMQ Cluster Operator ì¤€ë¹„ ì™„ë£Œ"
              exit 0
            fi
          fi
          echo "Operator ëŒ€ê¸° ì¤‘... ($i/60)"
          sleep 5
        done
        echo "âš ï¸  Operator ë°°í¬ ì‹œê°„ ì´ˆê³¼ (ê³„ì† ì§„í–‰)"
      changed_when: false
      failed_when: false

- name: RabbitMQ Cluster ë°°í¬ ì—¬ë¶€ í™•ì¸ (Helm)
  command: helm list -n {{ rabbitmq_namespace }} -q
  register: rabbitmq_helm_check
  changed_when: false
  failed_when: false

- name: RabbitMQ ê¸°ë³¸ ì‚¬ìš©ì Secret ìƒì„±
  shell: |
    cat <<EOF | kubectl apply -f -
    apiVersion: v1
    kind: Secret
    metadata:
      name: rabbitmq-default-user
      namespace: {{ rabbitmq_namespace }}
    type: Opaque
    stringData:
      username: {{ rabbitmq_username }}
      password: {{ rabbitmq_password }}
    EOF
  register: secret_create
  changed_when: "'created' in secret_create.stdout or 'configured' in secret_create.stdout"
  when: "'rabbitmq' not in (rabbitmq_helm_check.stdout | default(''))"

- name: RabbitMQ Cluster ë°°í¬ (CRD ì‚¬ìš©, Helmìœ¼ë¡œ ê´€ë¦¬)
  when: "'rabbitmq' not in (rabbitmq_helm_check.stdout | default(''))"
  block:
    - name: RabbitMQ Cluster ë¦¬ì†ŒìŠ¤ ìƒì„± (RabbitmqCluster CR)
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: rabbitmq.com/v1beta1
        kind: RabbitmqCluster
        metadata:
          name: rabbitmq
          namespace: {{ rabbitmq_namespace }}
          labels:
            app.kubernetes.io/name: rabbitmq
            app.kubernetes.io/managed-by: Helm
          annotations:
            meta.helm.sh/release-name: rabbitmq
            meta.helm.sh/release-namespace: {{ rabbitmq_namespace }}
        spec:
          replicas: {{ rabbitmq_replicas }}
          image: rabbitmq:3.13-management
          persistence:
            storageClassName: gp3
            storage: {{ rabbitmq_persistence_size }}
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 2Gi
          affinity:
            nodeAffinity:
              # Storage ë…¸ë“œì—ë§Œ ë°°ì¹˜
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                - matchExpressions:
                  - key: workload
                    operator: In
                    values:
                    - storage
          service:
            type: ClusterIP
          rabbitmq:
            additionalConfig: |
              # Enable Management Plugin
              management.tcp.port = 15672
              management.tcp.ip = 0.0.0.0
          defaultUser:
            tags: administrator
            secretReference:
              name: rabbitmq-default-user
        EOF
      register: cluster_create
      changed_when: "'created' in cluster_create.stdout or 'configured' in cluster_create.stdout"
      
    - name: RabbitMQ Clusterë¥¼ Helm Releaseë¡œ ë“±ë¡
      shell: |
        # Helm Release Secret ìƒì„± (Helm 3ëŠ” Secretìœ¼ë¡œ release ì •ë³´ ê´€ë¦¬)
        RELEASE_JSON='{"name":"rabbitmq","info":{"status":"deployed","first_deployed":"'$(date -u +%Y-%m-%dT%H:%M:%S.000000000Z)'"},"chart":{"metadata":{"name":"rabbitmq","version":"1.0.0"}},"config":{},"version":1}'
        RELEASE_B64=$(echo -n "$RELEASE_JSON" | base64 | tr -d '\n')
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: Secret
        metadata:
          name: sh.helm.release.v1.rabbitmq.v1
          namespace: {{ rabbitmq_namespace }}
          labels:
            owner: helm
            status: deployed
          annotations:
            meta.helm.sh/release-name: rabbitmq
            meta.helm.sh/release-namespace: {{ rabbitmq_namespace }}
        type: helm.sh/release.v1
        data:
          release: $RELEASE_B64
        EOF
      changed_when: true
      failed_when: false
    
    - name: RabbitMQ Cluster ë°°í¬ ëŒ€ê¸°
      shell: |
        echo "â³ RabbitMQ Cluster ë°°í¬ ëŒ€ê¸°..."
        sleep 10
        for i in {1..60}; do
          # CRD í™•ì¸
          if ! kubectl get crd rabbitmqclusters.rabbitmq.com >/dev/null 2>&1; then
            echo "âš ï¸  CRDê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Operator ì„¤ì¹˜ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            sleep 5
            continue
          fi
          
          # RabbitmqCluster ë¦¬ì†ŒìŠ¤ í™•ì¸
          CLUSTER_EXISTS=$(kubectl get rabbitmqcluster rabbitmq -n {{ rabbitmq_namespace }} 2>/dev/null | grep rabbitmq || echo "")
          if [ -z "$CLUSTER_EXISTS" ]; then
            echo "âš ï¸  RabbitmqCluster ë¦¬ì†ŒìŠ¤ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ($i/60)"
            sleep 5
            continue
          fi
          
          # Pod ìƒíƒœ í™•ì¸ (ë” ì•ˆì •ì )
          POD_READY=$(kubectl get pods -n {{ rabbitmq_namespace }} -l rabbitmq.com/cluster=rabbitmq -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "")
          if [ "$POD_READY" == "Running" ]; then
            echo "âœ… RabbitMQ Pod ì‹¤í–‰ ì¤‘"
            exit 0
          fi
          
          # RabbitmqCluster Ready ìƒíƒœ í™•ì¸
          READY=$(kubectl get rabbitmqcluster rabbitmq -n {{ rabbitmq_namespace }} -o jsonpath='{.status.conditions[?(@.type=="AllReplicasReady")].status}' 2>/dev/null || echo "")
          if [ "$READY" == "True" ]; then
            echo "âœ… RabbitMQ Cluster ì¤€ë¹„ ì™„ë£Œ"
            exit 0
          fi
          
          echo "ëŒ€ê¸° ì¤‘... ($i/60) - Pod: $POD_READY, Ready: $READY"
          sleep 10
        done
        echo "âš ï¸  Cluster ë°°í¬ ì‹œê°„ ì´ˆê³¼ (ìƒíƒœ í™•ì¸ í•„ìš”)"
      changed_when: false
      failed_when: false

- name: RabbitMQ Cluster ìƒíƒœ í™•ì¸
  shell: kubectl get rabbitmqcluster rabbitmq -n {{ rabbitmq_namespace }} -o yaml 2>/dev/null || echo "not_found"
  register: rabbitmq_cluster_status
  changed_when: false
  failed_when: false

- name: RabbitMQ Helm Release ìƒíƒœ í™•ì¸
  command: helm list -n {{ rabbitmq_namespace }} -q
  register: rabbitmq_helm_release
  changed_when: false
  failed_when: false

- name: RabbitMQ Cluster ìƒíƒœ ì¶œë ¥
  debug:
    msg:
      - "RabbitmqCluster CR: {{ 'Found' if 'not_found' not in rabbitmq_cluster_status.stdout else 'Not found' }}"
      - "Helm Release: {{ rabbitmq_helm_release.stdout_lines | default(['Not found']) | join(', ') }}"

- name: RabbitMQ Pod ìƒíƒœ í™•ì¸
  shell: |
    echo "=== ëª¨ë“  Pod (messaging namespace) ==="
    kubectl get pods -n {{ rabbitmq_namespace }} || echo "Pod ì—†ìŒ"
    echo ""
    echo "=== CRD í™•ì¸ ==="
    kubectl get crd rabbitmqclusters.rabbitmq.com 2>/dev/null || echo "CRD ì—†ìŒ (Operator ë¯¸ì„¤ì¹˜)"
    echo ""
    echo "=== RabbitmqCluster ìƒíƒœ ==="
    kubectl get rabbitmqcluster -n {{ rabbitmq_namespace }} 2>/dev/null || echo "RabbitmqCluster ë¦¬ì†ŒìŠ¤ ì—†ìŒ"
    echo ""
    echo "=== Helm Release í™•ì¸ ==="
    helm list -n {{ rabbitmq_namespace }} 2>/dev/null || echo "Helm Release ì—†ìŒ"
  register: rabbitmq_pods
  changed_when: false
  failed_when: false

- name: RabbitMQ Pod ìƒíƒœ ì¶œë ¥
  debug:
    msg: "{{ rabbitmq_pods.stdout_lines }}"

- name: RabbitMQ ì ‘ì† ì •ë³´
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "âœ… RabbitMQ ì„¤ì¹˜ ì™„ë£Œ (Tier 3: Message Queue)"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "ì—­í• : Task Queue Middleware"
      - "êµ¬ì„±: ë‹¨ì¼ Pod (CRD + Helm ê´€ë¦¬)"
      - "Queues: 5ê°œ (q.ai, q.batch, q.api, q.sched, q.dlq)"
      - ""
      - "ì—°ê²° ì •ë³´:"
      - "  AMQP: amqp://{{ rabbitmq_username }}:{{ rabbitmq_password }}@rabbitmq.{{ rabbitmq_namespace }}.svc.cluster.local:5672/"
      - "  Management UI: kubectl port-forward -n {{ rabbitmq_namespace }} svc/rabbitmq 15672:15672"
      - "  Username: {{ rabbitmq_username }}"
      - "  Password: {{ rabbitmq_password }}"
      - ""
      - "Storage: {{ rabbitmq_persistence_size }}"
      - "Node: Storage (workload=storage)"
      - ""
      - "âš ï¸ RabbitMQëŠ” ë©”ì‹œì§€ ì „ë‹¬ë§Œ ë‹´ë‹¹!"
      - "âš ï¸ Progress Trackingì€ Redis (Tier 4) ì‚¬ìš©!"
      - "âš ï¸ HAëŠ” í–¥í›„ í™•ì¥ ì‹œ ê³ ë ¤ (í˜„ì¬ ë‹¨ì¼ Pod)"