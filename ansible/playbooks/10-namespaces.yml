# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 10-namespaces.yml - 도메인별 네임스페이스 생성
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

---
- name: 도메인별 네임스페이스 생성
  hosts: masters
  become: yes
  gather_facts: no
  
  vars:
    kube_config: /etc/kubernetes/admin.conf
  
  tasks:
    - name: 네임스페이스 YAML 복사
      copy:
        src: ../../k8s/namespaces/domain-based.yaml
        dest: /tmp/domain-namespaces.yaml
        mode: '0644'
    
    - name: 네임스페이스 생성
      command: kubectl apply -f /tmp/domain-namespaces.yaml --kubeconfig={{ kube_config }}
      register: namespace_result
      changed_when: "'created' in namespace_result.stdout or 'configured' in namespace_result.stdout"
    
    - name: 생성된 네임스페이스 확인
      command: kubectl get namespaces -l app.kubernetes.io/part-of=ecoeco-backend --kubeconfig={{ kube_config }}
      register: ns_list
    
    - name: 결과 출력
      debug:
        msg: |
          ✅ 도메인별 네임스페이스 생성 완료
          {{ ns_list.stdout }}
    
    - name: NetworkPolicy YAML 복사
      copy:
        src: ../../k8s/networkpolicies/domain-isolation.yaml
        dest: /tmp/network-policies.yaml
        mode: '0644'
    
    - name: NetworkPolicy 적용
      command: kubectl apply -f /tmp/network-policies.yaml --kubeconfig={{ kube_config }}
      register: netpol_result
      changed_when: "'created' in netpol_result.stdout or 'configured' in netpol_result.stdout"
    
    - name: NetworkPolicy 확인
      command: kubectl get networkpolicies --all-namespaces --kubeconfig={{ kube_config }}
      register: netpol_list
    
    - name: NetworkPolicy 결과 출력
      debug:
        msg: |
          ✅ NetworkPolicy 적용 완료
          {{ netpol_list.stdout }}

