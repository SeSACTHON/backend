# Worker 노드 조인 (검증 강화)
---
# Pre-flight 체크
- name: Swap 비활성화 확인 (kubeadm 필수)
  command: swapon -s
  register: swap_check
  changed_when: false
  failed_when: swap_check.stdout != ""

- name: containerd 실행 확인
  command: systemctl is-active containerd
  register: containerd_check
  changed_when: false
  failed_when: containerd_check.stdout != "active"

- name: CRI 소켓 존재 확인
  stat:
    path: /run/containerd/containerd.sock
  register: cri_socket
  failed_when: not cri_socket.stat.exists

# Join 여부 확인
- name: 이미 조인되었는지 확인
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf

- name: Kubelet 상태 확인 (이미 join된 경우)
  command: systemctl is-active kubelet
  register: kubelet_status
  changed_when: false
  failed_when: false
  when: kubelet_conf.stat.exists

- name: Join 상태 출력
  debug:
    msg: "{{ '✅ 이미 join됨' if kubelet_conf.stat.exists else '⚠️ Join 필요' }}"

# Join 실행
- name: join 명령어 파일 복사
  copy:
    src: /tmp/kubeadm_join_command.sh
    dest: /tmp/join.sh
    mode: '0755'
  when: not kubelet_conf.stat.exists

- name: 클러스터 조인 (검증된 옵션)
  shell: |
    # Join 실행
    bash /tmp/join.sh --cri-socket=unix:///run/containerd/containerd.sock --v=5
    
    # 성공 확인
    if [ $? -eq 0 ]; then
      echo "✅ Join 성공"
      exit 0
    else
      echo "❌ Join 실패"
      exit 1
    fi
  when: not kubelet_conf.stat.exists
  register: join_result
  async: 300
  poll: 10

- name: Join 결과 출력
  debug:
    msg: "{{ join_result.stdout_lines }}"
  when: not kubelet_conf.stat.exists and join_result is defined

- name: Kubelet 서비스 시작 확인
  command: systemctl is-active kubelet
  register: kubelet_active
  changed_when: false
  retries: 10
  delay: 5
  until: kubelet_active.stdout == "active"

- name: join 명령어 파일 삭제
  file:
    path: /tmp/join.sh
    state: absent
