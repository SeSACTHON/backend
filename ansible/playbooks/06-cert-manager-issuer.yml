# Cert-manager ClusterIssuer 설정 (Let's Encrypt)
---
- name: Wait for cert-manager deployments to be ready
  command: kubectl wait --for=condition=available --timeout=300s deployment/{{ item }} -n cert-manager
  loop:
    - cert-manager
    - cert-manager-webhook
    - cert-manager-cainjector
  changed_when: false

- name: Wait for cert-manager webhook service
  shell: |
    for i in {1..30}; do
      if kubectl get svc cert-manager-webhook -n cert-manager &>/dev/null; then
        echo "Webhook service ready"
        exit 0
      fi
      echo "Waiting for webhook service... ($i/30)"
      sleep 5
    done
  changed_when: false

- name: Wait for cert-manager webhook endpoints
  shell: |
    for i in {1..30}; do
      ENDPOINTS=$(kubectl get endpoints cert-manager-webhook -n cert-manager -o jsonpath='{.subsets[*].addresses[*].ip}' 2>/dev/null)
      if [ -n "$ENDPOINTS" ]; then
        echo "Webhook endpoints ready: $ENDPOINTS"
        exit 0
      fi
      echo "Waiting for webhook endpoints... ($i/30)"
      sleep 5
    done
  changed_when: false

- name: Create Let's Encrypt ClusterIssuer (Production)
  shell: |
    cat <<EOF | kubectl apply -f -
    apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    metadata:
      name: letsencrypt-prod
    spec:
      acme:
        server: https://acme-v02.api.letsencrypt.org/directory
        email: {{ letsencrypt_email }}
        privateKeySecretRef:
          name: letsencrypt-prod
        solvers:
        - http01:
            ingress:
              class: nginx
    EOF
  register: letsencrypt_prod
  changed_when: "'created' in letsencrypt_prod.stdout or 'configured' in letsencrypt_prod.stdout"

- name: Create Let's Encrypt ClusterIssuer (Staging for testing)
  shell: |
    cat <<EOF | kubectl apply -f -
    apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    metadata:
      name: letsencrypt-staging
    spec:
      acme:
        server: https://acme-staging-v02.api.letsencrypt.org/directory
        email: {{ letsencrypt_email }}
        privateKeySecretRef:
          name: letsencrypt-staging
        solvers:
        - http01:
            ingress:
              class: nginx
    EOF
  register: letsencrypt_staging
  changed_when: "'created' in letsencrypt_staging.stdout or 'configured' in letsencrypt_staging.stdout"

- name: ClusterIssuer 확인
  command: kubectl get clusterissuer
  register: issuers
  changed_when: false

- name: ClusterIssuer 목록 출력
  debug:
    msg: "{{ issuers.stdout_lines }}"

