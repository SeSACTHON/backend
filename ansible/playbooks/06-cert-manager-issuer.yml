# Cert-manager ClusterIssuer 설정 (Let's Encrypt)
---
- name: Wait for cert-manager to be ready
  command: kubectl wait --for=condition=available --timeout=300s deployment/cert-manager -n cert-manager
  changed_when: false

- name: Create Let's Encrypt ClusterIssuer (Production)
  shell: |
    cat <<EOF | kubectl apply -f -
    apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    metadata:
      name: letsencrypt-prod
    spec:
      acme:
        server: https://acme-v02.api.letsencrypt.org/directory
        email: {{ letsencrypt_email }}
        privateKeySecretRef:
          name: letsencrypt-prod
        solvers:
        - http01:
            ingress:
              class: nginx
    EOF
  register: letsencrypt_prod
  changed_when: "'created' in letsencrypt_prod.stdout or 'configured' in letsencrypt_prod.stdout"

- name: Create Let's Encrypt ClusterIssuer (Staging for testing)
  shell: |
    cat <<EOF | kubectl apply -f -
    apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    metadata:
      name: letsencrypt-staging
    spec:
      acme:
        server: https://acme-staging-v02.api.letsencrypt.org/directory
        email: {{ letsencrypt_email }}
        privateKeySecretRef:
          name: letsencrypt-staging
        solvers:
        - http01:
            ingress:
              class: nginx
    EOF
  register: letsencrypt_staging
  changed_when: "'created' in letsencrypt_staging.stdout or 'configured' in letsencrypt_staging.stdout"

- name: ClusterIssuer 확인
  command: kubectl get clusterissuer
  register: issuers
  changed_when: false

- name: ClusterIssuer 목록 출력
  debug:
    msg: "{{ issuers.stdout_lines }}"

