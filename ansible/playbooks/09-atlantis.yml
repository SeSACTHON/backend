# Atlantis ì„¤ì¹˜ (Terraform GitOps)
# 14-Node Architecture: Monitoring ë…¸ë“œì— ë°°í¬
---
- name: "Atlantis namespace ìƒì„±"
  shell: |
    kubectl create namespace atlantis --dry-run=client -o yaml | kubectl apply -f -
  register: atlantis_namespace
  changed_when: "'created' in atlantis_namespace.stdout"

- name: "Atlantis Secret í™•ì¸"
  shell: |
    kubectl get secret atlantis-secrets -n atlantis 2>/dev/null || echo "NOT_FOUND"
  register: atlantis_secret_check
  changed_when: false

- name: "Atlantis Secret ìƒì„± ì•ˆë‚´ (ìˆ˜ë™ ìƒì„± í•„ìš”)"
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "âš ï¸  Atlantis Secretì„ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - ""
      - "í•„ìš”í•œ Secret:"
      - "  1. github-token: GitHub Personal Access Token"
      - "     - ê¶Œí•œ: repo, admin:repo_hook"
      - "     - ìƒì„±: GitHub Settings â†’ Developer settings â†’ Personal access tokens"
      - ""
      - "  2. github-webhook-secret: Webhook Secret (ëœë¤ ë¬¸ìì—´)"
      - "     - ìƒì„±: openssl rand -hex 20"
      - ""
      - "  3. aws-access-key-id: AWS Access Key ID"
      - "  4. aws-secret-access-key: AWS Secret Access Key"
      - ""
      - "Secret ìƒì„± ëª…ë ¹ì–´:"
      - "  kubectl create secret generic atlantis-secrets -n atlantis \\"
      - "    --from-literal=github-token='YOUR_GITHUB_TOKEN' \\"
      - "    --from-literal=github-webhook-secret='YOUR_WEBHOOK_SECRET' \\"
      - "    --from-literal=aws-access-key-id='YOUR_AWS_ACCESS_KEY_ID' \\"
      - "    --from-literal=aws-secret-access-key='YOUR_AWS_SECRET_ACCESS_KEY'"
      - ""
      - "ë˜ëŠ” íŒŒì¼ì—ì„œ ìƒì„±:"
      - "  kubectl create secret generic atlantis-secrets -n atlantis \\"
      - "    --from-file=github-token=/path/to/github-token.txt \\"
      - "    --from-file=github-webhook-secret=/path/to/webhook-secret.txt \\"
      - "    --from-file=aws-access-key-id=/path/to/aws-access-key-id.txt \\"
      - "    --from-file=aws-secret-access-key=/path/to/aws-secret-access-key.txt"
  when: atlantis_secret_check.stdout == "NOT_FOUND"

- name: "Atlantis ConfigMap ìƒì„±"
  shell: |
    kubectl create configmap atlantis-config -n atlantis \
      --from-literal=AWS_REGION=ap-northeast-2 \
      --dry-run=client -o yaml | kubectl apply -f -
  register: atlantis_configmap

- name: "Atlantis Deployment ì ìš©"
  shell: |
    kubectl apply -f {{ playbook_dir }}/../../k8s/atlantis/atlantis-deployment.yaml
  register: atlantis_deployment
  when: atlantis_secret_check.stdout != "NOT_FOUND"

- name: "Atlantis Pod Ready ëŒ€ê¸°"
  shell: |
    kubectl wait --for=condition=ready pod -l app=atlantis -n atlantis --timeout=300s
  when: atlantis_deployment is defined and atlantis_deployment.changed

- name: "Atlantis Serviceë¥¼ NodePortë¡œ ë³€ê²½ (ALB target-type: instance í•„ìˆ˜)"
  shell: |
    kubectl patch svc atlantis -n atlantis -p '{"spec":{"type":"NodePort"}}'
  register: atlantis_service_patch
  changed_when: "'patched' in atlantis_service_patch.stdout or 'unchanged' in atlantis_service_patch.stdout"
  when: atlantis_deployment is defined and atlantis_deployment.changed

- name: "Atlantis Service í™•ì¸"
  shell: |
    kubectl get svc atlantis -n atlantis
  register: atlantis_service
  changed_when: false

- name: "Atlantis Ingress í™•ì¸ (14-nodes-ingress.yamlì— í¬í•¨ë¨)"
  shell: |
    kubectl get ingress atlantis-ingress -n atlantis 2>/dev/null || echo "Ingress ì—†ìŒ (07-ingress-resources.ymlì—ì„œ ìƒì„± ì˜ˆì •)"
  register: atlantis_ingress_check
  changed_when: false

- name: "Atlantis ì •ë³´ ì¶œë ¥"
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "âœ… Atlantis ë°°í¬ ì™„ë£Œ"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - ""
      - "ğŸ“ ë°°í¬ ìœ„ì¹˜:"
      - "  - Namespace: atlantis"
      - "  - Node: k8s-monitoring (ì •í™•í•œ ë…¸ë“œ ì§€ì •: nodeAffinity)"
      - "  - Pod: atlantis-0"
      - ""
      - "ğŸŒ ì ‘ì† ì •ë³´:"
      - "  - URL: https://atlantis.growbin.app"
      - "  - Health Check: https://atlantis.growbin.app/healthz"
      - ""
      - "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:"
      - "  1. GitHub Webhook ì„¤ì •:"
      - "     - Repository Settings â†’ Webhooks â†’ Add webhook"
      - "     - Payload URL: https://atlantis.growbin.app/events"
      - "     - Content type: application/json"
      - "     - SSL verification: âœ… Enable SSL verification"
      - "     - Secret: (ìœ„ì—ì„œ ìƒì„±í•œ github-webhook-secret)"
      - "     - Events: Pull requests, Pushes"
      - ""
      - "  2. í…ŒìŠ¤íŠ¸ PR ìƒì„±:"
      - "     - terraform/ ë””ë ‰í† ë¦¬ ìˆ˜ì •"
      - "     - PR ìƒì„± â†’ ìë™ìœ¼ë¡œ 'atlantis plan' ì‹¤í–‰"
      - "     - PR ì½”ë©˜íŠ¸ì— 'atlantis apply' ì…ë ¥ â†’ Apply ì‹¤í–‰"
      - ""
      - "  3. Ingress í™•ì¸:"
      - "     - 14-nodes-ingress.yamlì— í¬í•¨ë¨ (07-ingress-resources.ymlì—ì„œ ìë™ ìƒì„±)"
      - "     - kubectl get ingress -n atlantis"
      - ""
      - "{{ atlantis_service.stdout_lines }}"
  when: atlantis_deployment is defined and atlantis_deployment.changed

