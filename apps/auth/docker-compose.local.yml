# apps/auth 로컬 개발용 Docker Compose
# 사용법: cd apps/auth && docker-compose -f docker-compose.local.yml up --build

services:
  db:
    image: postgres:16
    container_name: auth-local-postgres
    environment:
      POSTGRES_USER: sesacthon
      POSTGRES_PASSWORD: sesacthon
      POSTGRES_DB: sesacthon
    ports:
    - 5433:5432
    volumes:
    - auth-local-pgdata:/var/lib/postgresql/data
    healthcheck:
      test: [CMD-SHELL, pg_isready -U sesacthon -d sesacthon]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7
    container_name: auth-local-redis
    command: [redis-server, --appendonly, no]
    ports:
    - 6380:6379

  auth:
    build:
      context: ../..
      dockerfile: apps/auth/Dockerfile
    container_name: auth-local-api
    environment:
      # Database
      AUTH_DATABASE_URL: postgresql+asyncpg://sesacthon:sesacthon@db:5432/sesacthon
      # Redis
      AUTH_REDIS_BLACKLIST_URL: redis://redis:6379/0
      AUTH_REDIS_OAUTH_STATE_URL: redis://redis:6379/3
      # JWT (테스트용)
      AUTH_JWT_SECRET_KEY: local-test-secret-key-change-in-prod
      AUTH_JWT_ALGORITHM: HS256
      AUTH_JWT_ISSUER: localhost
      AUTH_JWT_AUDIENCE: api
      # Token Expiry
      AUTH_ACCESS_TOKEN_EXP_MINUTES: '180'
      AUTH_REFRESH_TOKEN_EXP_MINUTES: '43200'
      # Frontend
      AUTH_FRONTEND_URL: http://localhost:3000
      AUTH_COOKIE_DOMAIN: localhost
      # OAuth (로컬 테스트시 .env.local에서 로드)
      # AUTH_GOOGLE_CLIENT_ID: ${AUTH_GOOGLE_CLIENT_ID}
      # AUTH_GOOGLE_CLIENT_SECRET: ${AUTH_GOOGLE_CLIENT_SECRET}
      # AUTH_KAKAO_CLIENT_ID: ${AUTH_KAKAO_CLIENT_ID}
      # AUTH_NAVER_CLIENT_ID: ${AUTH_NAVER_CLIENT_ID}
      # AUTH_NAVER_CLIENT_SECRET: ${AUTH_NAVER_CLIENT_SECRET}
    env_file:
    - .env.local
    ports:
    - 8000:8000
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      # 개발 모드: 코드 변경 시 자동 반영
    - ../../apps:/app/apps:ro
    command: [uvicorn, apps.auth.main:app, --host, 0.0.0.0, --port, '8000', --reload]

volumes:
  auth-local-pgdata:
